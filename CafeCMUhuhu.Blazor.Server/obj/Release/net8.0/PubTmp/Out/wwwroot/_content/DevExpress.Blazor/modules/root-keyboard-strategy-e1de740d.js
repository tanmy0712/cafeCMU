import{k as e}from"./key-f9cbed1b.js";import{h as t,S as s,M as i,a as n,b as o,D as l,c as r,i as a,d,e as h}from"./menu-keyboard-strategy-ec303e3a.js";import{D as u}from"./dropdown-menu-keyboard-strategy-0adf881a.js";import{K as c}from"./keyboard-navigation-strategy-940ff3b3.js";import{M as m,S as b}from"./popup-1339ec31.js";import{D as p,F as y}from"./focushelper-cb993bae.js";const S=[".dxbl-btn:not([disabled]):not(.dxbl-toolbar-hidden-item)",".dxbl-btn-split:not([disabled]):not(.dxbl-toolbar-hidden-item)",".dxbl-toolbar-item-tmpl"].map((e=>`.dxbl-toolbar-menu-item > ${e}`)).join(",");class v extends u{constructor(e,t,s){super(e,t,S,s)}switchToNestedContent(){return!this.isSplitButtonMenuItem(this.selectedItemElement)&&super.switchToNestedContent()}doAction(e){if(this.isSplitButtonMenuItem(this.selectedItemElement)){const t=this.selectedItemElement.querySelector(".dxbl-dropdown-item.dxbl-btn");if(t)return void this.doClick(t,e)}super.doAction(e)}isSplitButtonMenuItem(e){return t(e,K)}}var x,C;!function(e){e[e.Header=0]="Header",e[e.Body=1]="Body"}(x||(x={})),function(e){e[e.Shown=0]="Shown",e[e.Closed=1]="Closed"}(C||(C={}));class E extends m{constructor(e,t,i){super(e,t),this._dispatcherAction=new p,this._activeSection=null,this._initialized=null,this._focusSemaphore=new s,this._parentStrategy=i,this._sectionElementMap={[x.Header]:null,[x.Body]:null},this._modalStatusSignal=new b}get headerElement(){return this._sectionElementMap[x.Header]}set headerElement(e){this._sectionElementMap[x.Header]=e}get bodyElement(){return this._sectionElementMap[x.Body]}set bodyElement(e){this._sectionElementMap[x.Body]=e}initialize(){this._initialized=this.initializeCore()}initializeCore(){return super.initialize(),this.headerElement&&this.bodyElement?Promise.resolve():this.shcheduleInitialization()}shcheduleInitialization(){return this._dispatcherAction.cancel(),new Promise((e=>{this._dispatcherAction.execute((()=>{super.initialize(),e()}))}))}queryItems(){return this.headerElement=this.targetElement.querySelector(".dxbl-modal-header"),this.bodyElement=this.targetElement.querySelector(".dxbl-modal-body"),[this.headerElement,this.bodyElement]}async activate(){var e;await this._initialized,y.cancelRestoreFocus();const t=null!==(e=this._activeSection)&&void 0!==e?e:x.Body;this.setActiveSection(t)}createItemStrategy(e){return e===this.headerElement?new I(this.navigator,this.headerElement):e===this.bodyElement?new g(this.navigator,this.bodyElement,this._parentStrategy,this._focusSemaphore,this._modalStatusSignal):null}handleKeyDown(t){return e.KeyUtils.getEventKeyCode(t)===e.KeyCode.Tab?(this.setActiveSection(this.toggleActiveSection()),!0):super.handleKeyDown(t)}toggleActiveSection(){return this._activeSection===x.Body?x.Header:x.Body}setActiveSection(e){const t=null!=e?e:x.Body,s=this.navigator.getStrategy(this._sectionElementMap[t]);this._focusSemaphore.doAllowedAction((()=>{null==s||s.activate()})),this._activeSection=t}onPopupShown(){super.onPopupShown(),this._modalStatusSignal.raise(this.targetElement,C.Shown)}onPopupClosed(){super.onPopupClosed(),this._modalStatusSignal.raise(this.targetElement,C.Closed)}}class I extends c{initialize(){super.initialize(),this.selectedItemIndex=0}queryItems(){return this.queryItemsBySelector(".dxbl-btn").filter((e=>e&&!t(e,"dxbl-invisible")))}handleKeyDown(t){switch(e.KeyUtils.getEventKeyCode(t)){case e.KeyCode.Enter:case e.KeyCode.Space:return this.raiseClickEvent(this.selectedItemElement,t.ctrlKey,t.metaKey,t.shiftKey),!0;case e.KeyCode.Left:return this.moveToPrevItem(!0),!0;case e.KeyCode.Right:return this.moveToNextItem(!0),!0;case e.KeyCode.Up:case e.KeyCode.Down:return!0;default:return super.handleKeyDown(t)}}}class g extends v{constructor(e,t,s,n,o){super(e,t,s),this._boundModalStatusChanged=this.modalStatusChanged.bind(this),this._levelController=new i,this._focusSemaphore=n,this._modalStatusSignal=o,this._modalStatusSignal.subscribe(this._boundModalStatusChanged)}get menuLevel(){return this._levelController.currentLevel}modalStatusChanged(e,t){t===C.Shown?this.onPopupShown():this.onPopupClosed()}initialize(){super.initialize(),this._levelController.updateState(this.selectedItemIndex,this.itemCount),this.selectedItemIndex=this._levelController.selectedItemIndex}activate(){this._focusSemaphore.doIfAllowed((()=>{super.activate()})),this._focusSemaphore.disallow()}handleLeftKey(e){return this.menuLevel>0?(this.moveToPrevLevel(e),!0):!!n(this.selectedItemElement)&&(this.moveToNextLevel(e,o.Last),!0)}handleRightKey(e){return!!n(this.selectedItemElement)&&(this.moveToNextLevel(e,o.First),!0)}doAction(e){n(this.selectedItemElement)&&this.moveToNextLevel(e,o.First),super.doAction(e)}moveToNextLevel(e,t){this.performShortcutEvent(e),this._levelController.moveToNextLevel(t),this._focusSemaphore.allow()}moveToPrevLevel(e){this.performShortcutEvent(e),this._levelController.moveToPrevLevel(),this._focusSemaphore.allow()}getShortcutContext(){return{level:this.menuLevel,selectedItemIndex:this.selectedItemIndex}}handlePopupClosed(){super.handlePopupClosed(),this._levelController.clearState()}addEventSubscriptions(){}removeEventSubscriptions(){this._modalStatusSignal.unsubscribe(this._boundModalStatusChanged)}}const f=":scope > .dxbl-btn-toolbar:not(.dxbl-virtual-toolbar)",_=[...[".dxbl-btn:not([disabled]):not(.dxbl-toolbar-hidden-item)",".dxbl-btn-split:not([disabled]):not(.dxbl-toolbar-hidden-item) > .dxbl-btn"].map((e=>`${f} .dxbl-toolbar-item[visible]:not(.dxbl-toolbar-edit) > ${e}`)),`${f} .dxbl-toolbar-btn-ellipsis[visible]:not([disabled]):not(.dxbl-toolbar-hidden-item) > .dxbl-btn`,`${f} .dxbl-toolbar-item[visible].dxbl-toolbar-item-tmpl`].join(","),w="dxbl-btn-split-dropdown",K="dxbl-btn-split",M=`.${K}`;class A extends l{queryItems(){return this.queryItemsBySelector(_)}getShortcutContext(){return{itemIndex:this.selectedItemIndex}}handleKeyDownCore(t){switch(e.KeyUtils.getEventKeyCode(t)){case e.KeyCode.Right:return this.subMenuStrategy||this.moveToNextItem(!0),!0;case e.KeyCode.Left:return this.subMenuStrategy||this.moveToPrevItem(!0),!0;case e.KeyCode.Home:return this.selectItem(0),!0;case e.KeyCode.End:return this.selectItem(this.itemCount-1),!0;case e.KeyCode.Up:if(t.altKey&&!t.shiftKey){if(this.isMenuExpanded())return this.requestSubMenuClose(),!0}else if(this.subMenuStrategy)return this.subMenuStrategy.focusLastItem(),!0;return!1;case e.KeyCode.Down:if(t.altKey&&!t.shiftKey){if(this.hasMenu())return this.requestSubMenuOpen(),this.focusSubMenuItemAsync(o.First),!0}else if(this.subMenuStrategy)return this.subMenuStrategy.focusFirstItem(),!0;return!1;case e.KeyCode.Tab:return!this.nestedContentSelected&&(this.requestSubMenuClose(),t.shiftKey?this.leaveBackward():this.leaveForward(),!0);case e.KeyCode.Enter:case e.KeyCode.Space:return this.hasMenu()&&this.focusSubMenuItemAsync(o.First),!1;default:return!1}}focusSubMenuItemAsync(e){return this.shouldRestoreFocus=r(this.targetElement),super.focusSubMenuItemAsync(e)}hasMenu(){return n(this.selectedItemElement)||t(this.selectedItemElement,w)}isMenuExpanded(){return a(this.selectedItemElement)||t(this.selectedItemElement,w)&&a(this.selectedItemElement.closest(M))}requestSubMenuOpen(){var e;null===(e=this.selectedItemElement)||void 0===e||e.dispatchEvent(new d(h.Expand))}requestSubMenuClose(){var e;null===(e=this.selectedItemElement)||void 0===e||e.dispatchEvent(new d(h.Collapse))}createPopupStrategy(e,t){return new v(e,t,this)}createModalStrategy(e,t){return new E(e,t,this)}}export{A as D};
