import{D as e}from"./layouthelper-0c7c89da.js";import{T as t,I as n}from"./constants-791d6f9b.js";import{L as s}from"./logicaltreehelper-7b19cc30.js";import{F as i}from"./focushelper-cb993bae.js";const o=["a[href]","audio[controls]","button",'[contenteditable]:not([contenteditable="false"])',"details>summary:first-of-type","details","input","select","textarea","[tabindex]","video[controls]"].join(",");class l{static getTabbables(e,t){const n=this.findTabbables(e,t),s=[],i=[];return n.forEach(((e,t)=>{const n=l.getTabIndex(e);0===n?s.push(e):i.push({index:t,tabIndex:n,item:e})})),i.sort(((e,t)=>e.tabIndex===t.tabIndex?e.index-t.index:e.tabIndex-t.tabIndex)).map((e=>e.item)).concat(s)}static findTabbables(e,t){const n=Array.from(e.querySelectorAll(o));return t&&(e.matches(o)||e.webkitMatchesSelector(o))&&n.unshift(e),n.filter(l.filterTabbable)}static filterTabbable(t){return!t.disabled&&(!l.isHiddenInput(t)&&(!e.isHidden(t)&&!(l.getTabIndex(t)<0)))}static getTabIndex(e){const n=e.getAttribute("tabindex");if(n){const e=parseInt(n,10);if(!isNaN(e))return e}return"true"===e.contentEditable||e.nodeName===t.audio||e.nodeName===t.video||e.nodeName===t.details?0:e.tabIndex}static isHiddenInput(e){return e.tagName===t.input&&e.getAttribute("type")===n.hidden}}class r{constructor(e){this.action=null,this.postponeAction=e}executePostpone(e){this.action=null,this.postponeAction()?e():this.action=e}execute(){this.action&&this.postponeAction()&&this.executeForce()}executeForce(){this.action&&this.action(),this.clear()}clear(){this.action=null}}const a={subtree:!0,childList:!0,attributeFilter:["disabled","tabindex"]};class c{constructor(e,t,n,s,i){this.BlockOutsideClick=!1,this.BlockOutsideNavigation=!1,this.NestedOnly=!1,this.BlockOutsideClick=e,this.BlockOutsideNavigation=t,this.Element=n,this.LastFocusedElement=s,this.NestedOnly=i}}const u=new class{constructor(){this.documentFocusInHandler=this.documentFocusIn.bind(this),this.documentKeyDownHandler=this.documentKeyDown.bind(this),this.firstInnerElementKeyDownHandler=this.firstInnerElementKeyDown.bind(this),this.lastInnerElementKeyDownHandler=this.lastInnerElementKeyDown.bind(this),this.handleFocusOutHandler=this.handleFocusOut.bind(this),this.documentKeyboardTrackerHandler=this.documentKeyboardTracker.bind(this),this.documentMouseTrackerHandler=this.documentMouseTracker.bind(this),this.tabbables=[],this.mutationObserver=new MutationObserver(this.handleMutations.bind(this)),this.focusPostponedAction=new r((()=>{var e,t;return null!==(t=(null===(e=this.tabbables)||void 0===e?void 0:e.length)>0)&&void 0!==t&&t})),this.firstInnerElement=null,this.lastInnerElement=null,this._stack=[],this._lastInputFromPointer=!1,document.addEventListener("keydown",this.documentKeyboardTrackerHandler,!0),document.addEventListener("pointerdown",this.documentMouseTrackerHandler,!0)}documentKeyboardTracker(e){this._lastInputFromPointer=!1}documentMouseTracker(e){this._lastInputFromPointer=!0}get isActivated(){return this._stack.length>0}get info(){return this.isActivated?this._stack[this._stack.length-1]:null}get element(){var e,t;return null!==(t=null===(e=this.info)||void 0===e?void 0:e.Element)&&void 0!==t?t:null}get blockOutsideClick(){var e,t;return null!==(t=null===(e=this.info)||void 0===e?void 0:e.BlockOutsideClick)&&void 0!==t?t:null}get blockOutsideNavigation(){var e,t;return null!==(t=null===(e=this.info)||void 0===e?void 0:e.BlockOutsideNavigation)&&void 0!==t?t:null}get lastFocusedElement(){var e,t;return null!==(t=null===(e=this.info)||void 0===e?void 0:e.LastFocusedElement)&&void 0!==t?t:null}get nestedOnly(){var e,t;return null!==(t=null===(e=this.info)||void 0===e?void 0:e.NestedOnly)&&void 0!==t?t:null}filterStack(e){e&&(this._stack=this._stack.filter((t=>t.Element!==e)))}activate(e,t,n=!1,s=t){if("string"==typeof e&&(e=document.querySelector(e)),null==e)throw"element is null";this.element&&this.deactivateCore();const i=document.activeElement;this.filterStack(e),this._stack.push(new c(s,t,e,i,n)),this.activateCore()}activateCore(){this.element&&((this.blockOutsideClick||this.blockOutsideNavigation)&&this.subscribe(this.element),this.tabbables=l.getTabbables(this.element,!this.nestedOnly),this.updateInnerElements(),this.subscribeInnerElementsKeyDown(),this.focusPostponedAction.executePostpone(this.forceFocusFirstElement.bind(this)),this.mutationObserver.observe(this.element,a))}deactivate(e,t){var n;if(!this.isActivated||!e)return;if(this.element!==e)return void this.filterStack(e);this.deactivateCore();const o=null===(n=this._stack.pop())||void 0===n?void 0:n.LastFocusedElement;t&&!s.containsElement(e,document.activeElement)&&o&&i.restoreFocus(o),this.element&&this.activateCore()}deactivateCore(){this.element&&(this.focusPostponedAction.clear(),this.mutationObserver.disconnect(),this.unsubscribeDocument(),this.unsubscribe(this.element),this.unsubscribeInnerElementsKeyDown(),clearTimeout(this.updateTabbablesTimerID))}forceFocusFirstElement(){const e=this.tabbables[0];e&&(this.lastFocusedElement&&this.element&&s.containsElement(this.element,document.activeElement)||i.restoreFocus(e))}handleMutations(e){clearTimeout(this.updateTabbablesTimerID),this.updateTabbablesTimerID=setTimeout((()=>{this.tabbables=l.getTabbables(this.element,!this.nestedOnly),this.unsubscribeInnerElementsKeyDown(),this.updateInnerElements(),this.subscribeInnerElementsKeyDown(),this.focusPostponedAction.execute()}),50)}subscribe(e){this.element.addEventListener("focusout",this.handleFocusOutHandler,!0)}unsubscribe(e){this.element.removeEventListener("focusout",this.handleFocusOutHandler,!0)}handleFocusOut(e){if(this._lastInputFromPointer){if(!this.blockOutsideClick)return}else if(!this.blockOutsideNavigation)return;const t=e.relatedTarget;t?this.element.contains(t)||this.focusPostponedAction.executePostpone(this.forceFocusFirstElement.bind(this)):this.subscribeDocument()}subscribeDocument(){document.addEventListener("focusin",this.documentFocusInHandler),document.addEventListener("keydown",this.documentKeyDownHandler)}unsubscribeDocument(){document.removeEventListener("keydown",this.documentKeyDownHandler),document.removeEventListener("focusin",this.documentFocusInHandler)}documentKeyDown(e){var t;const n=e.target;if(n&&(this.element===n||(null===(t=this.element)||void 0===t?void 0:t.contains(n))))return;const s=this.element;s&&s.processKeyDown(e)}documentFocusIn(e){const t=e.target;if(!t)return;this.unsubscribeDocument();const n=e.relatedTarget;(n||this.element.contains(t))&&(!n||this.element.contains(n))||this.focusPostponedAction.executePostpone(this.forceFocusFirstElement.bind(this))}firstInnerElementKeyDown(e){var t;this.firstInnerElement===document.activeElement&&"Tab"===e.key&&e.shiftKey&&(e.preventDefault(),null===(t=this.lastInnerElement)||void 0===t||t.focus({preventScroll:!1}))}lastInnerElementKeyDown(e){var t;this.lastInnerElement!==document.activeElement||"Tab"!==e.key||e.shiftKey||(e.preventDefault(),null===(t=this.firstInnerElement)||void 0===t||t.focus({preventScroll:!1}))}unsubscribeInnerElementsKeyDown(){var e,t;null===(e=this.firstInnerElement)||void 0===e||e.removeEventListener("keydown",this.firstInnerElementKeyDownHandler),null===(t=this.lastInnerElement)||void 0===t||t.removeEventListener("keydown",this.lastInnerElementKeyDownHandler)}subscribeInnerElementsKeyDown(){var e,t;null===(e=this.firstInnerElement)||void 0===e||e.addEventListener("keydown",this.firstInnerElementKeyDownHandler),null===(t=this.lastInnerElement)||void 0===t||t.addEventListener("keydown",this.lastInnerElementKeyDownHandler)}updateInnerElements(){this.tabbables&&(this.firstInnerElement=this.tabbables[0],this.lastInnerElement=this.tabbables[this.tabbables.length-1])}};export{u as f};
